# Command Line Interface (CLI)

The CLI of my.saas provides the following features:

- Infrastructure as a Code (IaaC),
- Continious Deployment (CD),
- Processes Monitoring; and
- Infrastructure Monitoring.


## 1. The `saas` Command

The `saas` command simply receives the name of a Ruby **script** that you want to execute.

```
saas <ruby script filename>
```

The `saas` command will look for such a script into the folder specified in the environment variable `$SAASLIB`. 

If the script your call receives parameters, then you can add them.

```
saas <ruby script filename> <list of command line parameters>
```

Here is the list of scripts you can execute:

| script      | example                                       | description                                                                                                                                          |
|-------------|-----------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| create      | `saas create node=master`                     | Create a new instance of a cloud server into a hosting provider like Contabo.                                                                        |
| install     | `saas install nodes=master,slave01`           | install standard environment into an Ubuntu 20.04 server.                                                                                            |
| deploy      | `saas deploy nodes=master,slave01,worker01`   | Deploy the latest version of my.saas and the configured extensions, including source code, gems, sql migrations and updating SSL certifications too. |
| stop        | `saas stop nodes=master,s01,w0101 procs=*`    | Stop a specific process or all processes running into one or more nodes.                                                                             |
| start       | `saas start nodes=master,s01,w0101  procs=*`  | Start a specific list of processes into one or more nodes.                                                                                           |
| restart     | `saas restart nodes=master,s01,w0101 procs=*` | Restart a specific list of process into one or more nodes.                                                                                           |
| push-secret | `saas push-secrets`                           | Submit the secret files to your secret repository.                                                                                                   |
| pull-secret | `saas pull-secrets`                           | Download the secret files from your secret repository.                                                                                               |
| deploy      | `saas deploy clean=yes`                       | Clean the checkpoint of SQL migrations.                                                                                                              |
| ssh         | `saas ssh node=s01`                           | Open a SSH connection to a specific node.                                                                                                            |
| reboot      | `saas reboot nodes=master,slave01`            | Reboot a node.                                                                                                                                       |
| procs       | `saas procs nodes=master,s01,w0101`           | Show list of processes defined for each node, and show which ones are running and which ones are not.                                                |
| log         | `saas log nodes=master,s01,w0101`             | Show one log of the ones defined for those nodes, and watch it.                                                                                      |
| stat        | `saas stat nodes=master,s01,w0101`            | Watch the usage of CPU, memory, and disk space of each node if your infrastructure.                                                                  |
| proxies     | `saas proxies nodes=p01`                      | Show list of proxies defined for each node, and show which ones are running and which ones are not.                                                  |

## 2. Define Nodes

This is the IaaC part.

You can add a node to your infrastructure.

```ruby
BlackStack::MySaaS::IaaC.add_node({
    # Unique name to identify a host (a.k.a.: node).
    # It is equal to the hostname of the node.
    # Mandatory.
    :name => 'master', 

    # If true, this node is belonging your development environment.
    # If true, ignore this node when deploying.
    # Optional. Default: false.
    :dev => false, 

    # Public Internet IP address of the node.
    # If `nil`, that means that no instance of a cloud server has been created yet for this node.
    # Optional. Default: `nil`.
    :net_remote_ip => nil,

    # Which poort is sinatra listening.
    # This value is used for monitoring.
    # Optional. Default: 3000.
    :web_port => 3000,

    # Who is providing this node.
    # Allowed values: [:contabo].
    # Optional. Default: :contabo.
    :provider => :contabo,

    # What service is this.
    # If :provider is :contabo, allowed values are ['CLOUD VPS 1', 'CLOUD VPS 3', 'CLOUD VPS 6']
    # Mandatory.
    :service => 'CLOUD VPS 1',

    # Reference to another node where is hosted the database to work with.
    # Mandatory.
    :db_host => 'dev2',

    # SSH credentials.
    :ssh_username => 'blackstack',
    :ssh_port => 22,
    :ssh_password => '<write SSH password here>',

    # Root password is required to install the environment at the first time.
    :ssh_root_password => '<write SSH password here>',

    # Parameters to connect to the github repositories.
    #
    :git_repository => 'leandrosardi/my.saas',
    :git_branch => 'main', 
    :git_username => 'leandrosardi',
    # Instead of GitHub password, you have to provide an access token.
    # How to get a GitHub access token: https://docs.github.com/en/apps/creating-github-apps/authenticating-with-a-github-app/generating-a-user-access-token-for-a-github-app 
    :git_password => '<your github access token>',
    
    # Folder into where you want to clone the repository defined in `git_repository`.
    # Mandatory.
    :code_folder => '/home/blackstack/code1/master',

    # List of processes to start
    # Optional. Default: [].
    :procs => {
        # list of commands to run when starting a node.
        :start => [
            {
                # the command you are executing must be located into `code_folder`.
                :command => 'app.rb port=3000',
                # where to redirect any output in the starting of this command.
                # note that the command may log into another file once it started.
                :stdout => '/home/blackstack/code1/master/app.log',
                :stderr => '/home/blackstack/code1/master',
                # value to assign to the environment variable `$RUBYLIB`
                :rubylib => '/home/blackstack/code1/master',
            }, {
                ...
            }
        ],
        # list of commands to kill when stopping a node.
        :stop => [
            'app.rb port=3000',
            'adspower',
            ...
        ],
    },

    # List of logfiles allowed to watch or monitor.
    # Optional. Default: [].
    :logs => [
        '/home/blackstack/code1/master/app.log',
        ... 
    ]
})
```

Note that if the hash descriptor passed to the `add_node` method has not the right format, of if there are missed parameters, or if there are unknown parameters; then such a method will raise an exception `Node hash descriptor mailformed.`

## 2. Create Nodes

You can create a new instance of a cloud server for any of the nodes you have defined.

- You can do that by Ruby code:


```ruby
BlackStack::MySaaS::IaaC.create :master
```

- Or you can do it with the CLI:

```
saas create nodes=master
```

- If the node has been already created, the command will raise an exception.

```
saas create nodes=master
Error: Command already created.
```

- You can also request the creation all nodes using regular expressions.

```
saas create nodes=*
```

- You can also request the creation some nodes by listing them separated by commas.

```
saas create nodes=master,slave01
```

- You can do both: listing many nodes, and using regular expressions in some elements of the list.

```
saas create nodes=master,slave.*
```

## 3. Release Node

If you have manually deleted the instance of a node from your hosting provider, you can update that your database.

The `release` script simply assign `nil` value to the field `net_remote_ip`.

- You can do that by Ruby code:


```ruby
BlackStack::MySaaS::IaaC.release :master
```

- Or you can do it with the CLI:

```
saas create nodes=master,slave.*
```

## 4. Install Environment

Install the my.saas envoronment into one node, by running the script `install.20.04.sh`.

- You can do that by Ruby code:


```ruby
BlackStack::MySaaS::IaaC.install :master
```

- Or you can do it with the CLI:

```
saas install nodes=master,slave.*
```

## 5. Deployment

This command will:

- pull the latest version of source code of my.saas from the branch specified in `git_branch`,

- pull the latest version of source code of each [extension](/docu/16.extensibility.md) specified in the `config.rb`, 

- run `bundler update`,

- execute all sql migrations in the folder `sql`,

- install SSL certification.


- You can do that by Ruby code:


```ruby
BlackStack::MySaaS::IaaC.deploy :master
```

- Or you can do it with the CLI:

```
saas deploy nodes=master,slave.*
```

## 6. Stop

Stop a specific process or all processes running into one or more nodes.

_complete the rest of documentation__

## 7. Start

Start a specific list of processes into one or more nodes.

_complete the rest of documentation__

## 8. Restart

Restart a specific list of process into one or more nodes.

_complete the rest of documentation__

## 9. Push Secrets

Submit the secret files `config.rb` from your local environment to your secret repository.

First thing first, you have to define what are your secrets.

E.g.:

```ruby
BlackStack::MySaaS::IaaC.set_secrets({
    # define your secret repository.
    :git_repository => 'leandrosardi/my.secrets',
    :git_branch => 'main', 
    :git_username => 'leandrosardi',
    # Instead of GitHub password, you have to provide an access token.
    # How to get a GitHub access token: https://docs.github.com/en/apps/creating-github-apps/authenticating-with-a-github-app/generating-a-user-access-token-for-a-github-app 
    :git_password => '<your github access token>',

    # define your secret files.
    :secrets => [
        {
            # this is where you place the source code for the master node.
            #
            # representative name of this secret.
            :name => :master,
            # path in my local environment where this secret is placed.
            :path => 'home/leandro/code1/master/config.rb',
        }, {
            # this is where you place the source code for any slave node.
            #
            # representative name of this secret.
            :name => :slave,
            # path in my local environment where this secret is placed.
            :path => 'home/leandro/code1/slave/config.rb',
        }
    ]
})
```

Then,

- You can do that by Ruby code:


```ruby
BlackStack::MySaaS::IaaC.push_secret :master
```

- Or you can do it with the CLI:

```
saas push secrets=master,slave
```

Note that if the hash descriptor passed to the `set_secrets` method has not the right format, of if there are missed parameters, or if there are unknown parameters; then such a method will raise an exception `Secret hash descriptor mailformed.`

## 10. Pull Secrets

Download the secret files from your secret repository to your local environment.

_complete the rest of documentation__

## 11. Connect via SSH

Open a SSH connection to a specific node.

_complete the rest of documentation__

## 12. Reboot

Reboot nodes.

_complete the rest of documentation__

## 19. Logging

Every command write into its own logfile.

The same outout you see in your terminal is saved into a log file.

Logfiles are located in the path you defined in the variable `$SAASLIB`

## 20. Silent Mode

Any command you run, it can be ran in `silent` mode by simply redirecting `STDOUT` and `STDERR`, and running in backend.

E.g.:

```
saas procs nodes=.* > /dev/null 2>&1 &
```

Running a command in silent mode allows you to launch it into a server and monitor your infrastructure 24/7 and receive an email alert as soon as an alert is raised.