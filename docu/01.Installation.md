# Installation

This tutorial is about how to install and run MySaaS in either

1. your development environment, and
2. your production environment.

Outline:

1. [Setup Environment](#1-setup-environment)
2. [Fork MySaaS](#2-fork-mysaas)
3. [Database Installation](#3-database-installation)
4. [Configuration File](#4-configuration-file)
5. [Test Database Connection](#5-test-database-connection)
6. [Run Database Migrations](#6-run-database-migrations)
7. [Run the App](#7-run-the-app)
8. [Running on Production](#8-running-on-production)

## 1. Setup Environment

MySaaS has been developed and tested on the following environment:
- Ubuntu 20.04
- Ruby 3.1.2
- Bundler 2.3.7

The command below install such an environment in your computer.

```bash
wget https://raw.githubusercontent.com/leandrosardi/environment/main/sh/install.ubuntu.20_04.sh -O - | bash
```

Find out the source code of our installation script in my other [environment](https://github.com/leandrosardi/environment) project.

## 2. Clone MySaaS

```bash
mkdir ~/code
cd ~/code
git clone https://github.com/leandrosardi/my.saas
```

4. Install requrired gems

```bash
cd ~/code/my.saas
bundler update
```

## 3. Database Installation

MySaaS runs on wither [PostgreSQL](https://www.postgresql.org) or [CockroachDB](https://www.cockroachlabs.com). 

**PostgreSQL**

PostgreSQL is installed in your local computer by the [environment installation scripts](https://github.com/leandrosardi/environment) intruduced in the section 1.

For further steps about how to setup a new database, refere to [Section 4: PostgreSQL](https://github.com/leandrosardi/environment?tab=readme-ov-file#4-postgresql) in the documentation of our [environment installation scripts](https://github.com/leandrosardi/environment).

**CockroachDB**

CockroachDB is installed in your local computer by the [environment installation scripts](https://github.com/leandrosardi/environment) intruduced in the section 1.

For more details about creating a database for development in your local computer, refer to this [tutorial](https://www.cockroachlabs.com/docs/stable/install-cockroachdb-linux) to install CockroachDB locally.

To run the CockroachDB server installed in your local computer, executre the command below:

```bash
cockroach start-single-node --insecure
```

For creating cloud and serverless database for production, refer to [this tutorial](./01.Installing-crdb.md) for:

	1. Creating your free-tier CockroachDB instance;
	2. Setting up your connection on `config.rb`; and
	3. Deploying all database migrations.

## 4. Configuration File

First, you need a configuration file:

```bash
cd ~/code/my.saas
cp ./config.template.rb ./config.rb
```

## 5. Database Connection

In such a configuration file, edit the database connection parameters:

```ruby
BlackStack::PostgreSQL::set_db_params({ 
  :db_url => '127.0.0.1', 
  :db_port => '5432', 
  :db_name => 'demo', 
  :db_user => 'blackstack', 
  :db_password => '<your db password here>',
})
```

Test the database connection.

```bash
export RUBYLIB=~/code/my.saas
cd ~/code/my.saas/cli
ruby conn.rb
```

## 6. SSH Connection

In the same configuration file, edit the SSH connection to your local computer, where MySaaS will run:

```ruby
# declare production nodes.
# .BlackStack.sandbox? flag doesn't play here.
# both cs.pem file and config.rb file are always taken from the local dev machine (leandro).
BlackStack::Deployer::add_nodes([
  {
    # unique name to identify a host (a.k.a.: node)
    #
    :name => 'node01',

    # ssh
    # use either `ssh_password` or `ssh_private_key_file` for identification.
    # 
    :net_remote_ip => '127.0.0.1',  
    :ssh_username => 'leandro',
    :ssh_port => 22,
    :ssh_password => '<write the SSH password of your local computer here>',
    #:ssh_private_key_file => '/home/leandro/code/my.saas/cli/cs.pem',
    
    # github credentials
    # 
    # Generate GitHub app password following the instructions here:
    # https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens 
    # 
    :git_repository => 'leandrosardi/my.saas',
    :git_branch => 'main',
    :git_username => 'leandrosardi',
    :git_password => '<your GitHub access token here>',
    
    # code folder
    # name of the folder where source code is placed
    # 
    :code_folder => 'demo',

    # name of the LAN interface
    :laninterface => 'eth0',

    # sinatra
    :web_port => 3000,

    # config.rb content
    #
    # Escape the double-quotes (") to make it embeddeable in the bash script generated by /deployment/default.rb.
    # (`echo "%config_rb_content%"` > ./config.rb)
    #
    # Don't call `File.read("$RUBYLIB/config.rb")` because the `$RUBYLIB` is not managed by the File module.
    # Use the `ENV` array instead.
    #
    # Don't use ``cat $RUBYLIB/config.rb`` because it won't be mapped to production,
    # because my-ruby-deployer will remove any text between ``.
    # 
    # Don't use the `sandbox?` method here, because the commands in the /cli folder must run with no `.sandbox` flag.
    # 
    :config_rb_content => File.read(ENV['RUBYLIB']+'/config.rb').gsub(/"/, '\"'),

    # default deployment routine for this node
    # 
    :deployment_routine => 'default',

    # this is always the folder where the app.rb file is located,
    # and from where you will run all the processes who run in this node.
    # 
    :rubylib => "~/code/demo",

    # processes to run on this node
    # all these processes are run in the background
    # all the processes are located into the $RUBYLIB folder
    # all these
    # 
    :processes => [
      # Webserver
      #
      'app.rb port=3000 config=./config.rb',
      
      # Look for new records in the table event. 
      # Apply AI to detect opportunities and craft direct messages. 
      # Insert into outbox.
      # 
      #'p/filter.rb',
      
      # Look for new records in the table outbox. 
      # Look for available profiles. 
      # Update outbox.id_profile.
      # 
      #'p/plan.rb',
    ],
    # logfiles to watch
    # 
    :logfiles => [
      OUTPUT_FILE, # '~/deployment.log',
      #'$RUBYLIB/filter.log',
      #'$RUBYLIB/plan.log',
    ],
  }
])
```

Test SSH connection.

```bash
export RUBYLIB=~/code/my.saas
cd ~/code/my.saas/cli
ruby ssh.rb node=node01
```

## 6. Deployment

The CLI command `deploy.rb` will:

- connect the database, and run all the SQL scripts in the `/sql` folder;
- connect `node01` via ssh;
- pull the source code from GitHub to the folder `~/code/demo`;
- run bundler to install all required gems;
- pull the source code of all the [project extensions](./16.extensibility.md);
and finally,
- start all the processes assigned to run on `node01`, including the web service.

```bash
export RUBYLIB=~/code/my.saas
cd ~/code/my.saas/cli
ruby deploy.rb
```

## 7. Run the App

After you have MySaaS configured to connect to CockroachDB, and all the database migrations installed, you can put your SaaS online.

Before running the `app` command, you need to edit the environment variable `$RUBYLIB`.

```bash
export RUBYLIB=~/code/my.saas
```

Then, you are good to run your app.

```bash
cd ~/code/my.saas/
ruby app.rb
```

![Running Webserver](https://user-images.githubusercontent.com/55877846/233084747-78509c55-fdb2-4f95-b504-78a93262e605.png)

Now, you go to [https://127.0.0.1:3000](https://127.0.0.1:3000) and access the platform account with the default credentials for the **system owner**:
- email: su
- password: Testing123

![Login Screen](https://user-images.githubusercontent.com/55877846/233084855-97befabf-ac32-474b-8f74-b482df682e80.png)

If you want to use another file different than `config.rb`, use the `config` parameter.

```bash
cd ~/code/my.saas
ruby app.rb config=my_config
```

If you want to use another port different than `3000`, use the `port` parameter.

```bash
cd ~/code/my.saas
ruby app.rb port=8080
```

## 8. Running on Production

- Refer to this tutorial about [how to install a serverless instance of CockroachDB](./01.Installing-crdb.md).

- Refer to this tutorial about how to [setup an Elastic Server on AWS](./01.installing-aws.md).

- Refer to this other tutorial about how to [deploy from your local computer to AWS](./04.deployment.md).