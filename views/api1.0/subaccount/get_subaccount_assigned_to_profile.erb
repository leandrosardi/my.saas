<%
# signup new account
@return_message = {}
begin
	id_profile = @body['id_profile']
	ds = DB["
		select l.id_profile, s.api_key, s.dashboard_node
		from \"lease\" l
		join \"subaccount\" s on s.id=l.id_subaccount
		where l.delete_time is null -- the leased has not expired

		--and l.id_subscription -- the client paid for the account

		and s.dashboard_node is not null -- the subaccount has been assisgned to a node
		and s.api_key is not null -- the subaccount signed up into the node

		and l.id_profile='#{id_profile}'
	"]

	# if there is no subaccount assigned, then there is a mistake.
	# if there is more than one subaccounts assigned, then there is a mistake too.
	if ds.count == 0
		raise "Profile #{id_profile} is not assigned to any subaccount."
	elsif ds.count > 1
		raise "Profile #{id_profile} is assigned to more than one subaccounts."
	else
		dashboard_node = ds.first[:dashboard_node]
		api_key = ds.first[:api_key]
		@return_message = {
			'url' => dashboard_node,
			'api_key' => api_key,
		}
	end

	# return success
	@return_message['status'] = 'success'
rescue => e
    #@return_message['status'] = @body['backtrace'] ? e.to_console : e.message
end
return @return_message.to_json
%>
